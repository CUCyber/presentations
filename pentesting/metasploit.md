# Intro To Metasploit

By: Mackenzie Binns

CU Cyber


## You Can Find These Presentations Online

Visit [cucyber.net](https://cucyber.net/) to find these presentations and more online!



# What is Metasploit


## It's not Latin

* The root term in Metasploit is "-sploit"
* Metasploit is primarily an exploitation framework that uses "payloads to perform a defined set of operations to compromise a system.


## Payloads

* A payload is what Metasploit uses to preform exploits
* Automated exploit on a system that matches criteria for the payload
* Payload can facilitate creating a remote shell on the system

Note:
* I.E a system that has heartbleed vulnerable OpenSSL v1 & 2


## Database
* Metasploit uses a PostGres Database to manage a work flows and information
* This database can hold recovered usernames, passwords, sessions, etc.



# Setting up Database


## Ubuntu Installation

```bash
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt/ `lsb_release -cs`-pgdg main" >> /etc/apt/sources.list.d/pgdg.list'

wget -q https://www.postgresql.org/media/keys/ACCC4CF8.asc -O - | sudo apt-key add -
```

* You then need to update your package manager to recognize the new repository

```bash
sudo apt-get update

sudo apt-get install postgresql postgresql-contrib
```

Note:
* After all this is done you will now have a user on your system called postgres
* This user will have the role postgres and you will be able to log in as this user to preform administration of the DB
* you may want to change your password using passwd to the postgres user


## Fedora Installation

* Install postgres on your system

```bash
sudo dnf install postgresql-server postgresql-contrib
```

* On fedora postgres is turned off and disabled by default to enable it run the command of your choice below

```bash
# To start the server at start up
sudo systemctl enable --now postgresql
```

```bash
# To run the server as needed
sudo systemctl start postgresql
```


## Kali linux

* Setting up the database is much easier in Kali linux
* First you must start the postgres service
```bash
service postgresql start
```
* You must then create the database so Metasploit can utilize it
```bash
msfdb init
```
* Done!


## Initializing the database

* Before postgres can work correctly you must initialize a database
* Switch your user to the postgres user using either

```bash
# Prefered method
sudo -i -u postgres
#alternate method
su postgres
```

* Then initialize the database after you have become the postgres user

```bash
initdb --locale $LANG -E UTF8 -D '/var/lib/postgres/data'
```

* Now you can enable the postgres server with no errors
Note:
* --locale pulls information from /etc/locale.conf
* -E is the default encoding of the DB
* -D is default location where the cluster is stored
    * if default location is changed you must update the service file
    * if root is under home then make sure you turn off the ProtectHome option


## Creating the msf database

* We need to create a user that metasploit will connect to the database with

```bash
createuser <username> --interactive
```

* Now we need to create a database the msf will be able to use

```bash
createdb msf -u <username>
```

Note:
* When creating the user answer: n/y/y
* when creating the database name it msf so that its easy to work with in metasploit



# Setting up Metasploit


## Connect metasploit to the DB

* Now we need to tell metasploit what user to connect to the database with
* Also what database to connect to.

```bash
db_connect <username>@msf

# You can alias msfconsole in your .bashrc to run it everytime
# quiet disables ascii art
alias msfconsole="msfconsole --quiet -x \"db_connect <username>@msf\""
```

* After which you will need to build the database cache might take a few minutes

```bash
db_rebuild_cache
```

Note:
* You will have to run this every time you connect to your msfconsole
* Check the db_status



# Metasploit info


## Module types

* Everything in metasploit is a module
* 6 types of modules
    * auxiliary
    * exploit
    * payload
    * post
    * encoder
    * nop


### Auxiliary

* Modules that are good for information gathering
* Port scanning
* Version detection
* Network Traffic analysis


### Exploit

* The code that will take advantage of a vulnerability
* This could be used for example to exploit a buffer overflow


### Payload

* This is typically done after a successful exploit
* Can be used to preform an action on the server once compromised 
    * Open a remote shell
    * Meterpreter session


### Post

* This is typically done after a successful exploit and remote connections are set
* This is used for collecting passwords
* Setting up key loggers 
* Downloading files


### Encoder

* Programs for performing encryption


### NOP

* NOP generators for creating assembly code that does nothing



# Searching Metasploit


## Search filters

* Searching with the database is very fast
* Search fields
    * app
    * author
    * type
    * name
    * platform
    * bid,cve,edb,osvdb,ref


### App

* Client
* Server


### Author

* Module author


### Type

* auxiliary
* exploit
* payload
* post
* encoder
* nop


### Name

* Any phrase


### Platform

* The type of thing you are looking at attacking
* Ex.) Windows, linux, python, ruby, Cisco, Ect.


### Searching exploit databases

* Allows you to search CVE exploit ID's



# Using Metasploit


## man use

* use <exploit> will load the exploit and allow you to use it 

```bash
use <path to exploit>
```

* info command is like a man page for metasploit commands

```bash
info <path to exploit>
```


## Firing off an exploit!

* After you select an exploit to use you must configure the setting to match your target
```bash
show options
```

* Show options will provide a list of things you need/would like to configure before the exploit can be used


### Show options basics

* RHOST
    * Remote host, typically an IP address or a DNS name
* RHOSTS
    * Same as RHOST but can define multiple targets 
* RPORT
    * The port to attack on the remote host, this is typically configured to be the default for the service, but can be changed just in case it is not default
* RPORTS
    * Same as RPORT but can define multiple targets 
* Wordlist
    * Allows you define a list of passwords to be used for brute forcing modules

Note:
* Word lists can be found online, ROCKYOU is a good starting point


## Payloads

* You can run exploits with out a payload.
* They will do nothing for you and you will not be able to do anything to the machine
* To be able to establish a connection to the exploited machine you must provide a payload

```bash
# Reverse TCP is an excellent payload to start with
set payload <path to payload>
```
* When you choose a payload it will add more options to your exploit
* You will want to set LHOST to your computers IP address

Note:
* What command should be run to show the new options



# Questions?



# Resources


## Database Resources

* [Working with the DB in metasploit](https://www.offensive-security.com/metasploit-unleashed/using-databases/#Setup)
* [Fedora PostGres](https://fedoraproject.org/wiki/PostgreSQL)
* [Ubuntu PostGres](http://tecadmin.net/install-postgresql-server-on-ubuntu/#)
* [Arch Wiki (Really good resource)](https://wiki.archlinux.org/index.php/PostgreSQL)


## Metasploit Resources

* [Offensive Security](https://www.offensive-security.com/metasploit-unleashed/)
